/*************************************************************************
 *
 * National center for performance measurement (Adaa)
 * __________________
 *
 *  [2020] Adaa
 *  All Rights Reserved.
 *
 * NOTICE:  All information contained herein is, and remains
 * the property of Adaa and its suppliers,
 * if any.  The intellectual and technical concepts contained
 * herein are proprietary to Adaa and its suppliers and may
 * be covered by S.A. and Foreign Patents, patents in process,
 * and are protected by trade secret or copyright law.
 * Dissemination of this information or reproduction of this material
 * is strictly forbidden unless prior written permission is obtained
 * from Adaa.
 *
 * Author: Abudalrhman A. Alghibban.
 * Date: 2020 - 06.
 * __________________
 * File Summary
 * __________________
 *
 * The main purpose of the App.js file is the following:
 * 1- Calling the backend API's to provide:
 *  * Create new vendor.
 *  * Upload vendor files.
 * 2- Validating the user input and handling the
 *    UI status changes , hiding controllers , changing colors and so on.
 */

/**
 * this variable will hold
 * validation status of the
 * submitted form.
 * @type {boolean}
 */
let isFormValid = true;
let googleToken = "";

/**
 *  This function will loop for each control in VRS page
 *  it will check if the control is textbox or file if so
 *  it validate it's value and make sure it hase value in it.
 * @param {HtmlControl} onlyThis Only validate on this control.
 * @param {boolean} callingWithSubmit wither calling this function was fired from submit event or not.
 */
function Validation(onlyThis = null, callingWithSubmit = false) {
    isFormValid = callingWithSubmit;
    if (onlyThis === null) {
        const controllers = document.getElementsByTagName("INPUT");
        for (let control = 0; control < controllers.length; control++) {
            if (controllers[control].type === "text" || controllers[control].type === "file") {
                if (controllers[control].id !== "FileInvestor") {
                    if(controllers[control].id !== "FileLicenses"){
                        if (controllers[control].value === "" || controllers[control].value.length === 0) {
                            SetControlAsNotValid(controllers[control].id);
                            isFormValid = false;
                        } else {
                            SetControlAsValid(controllers[control].id);
                        }
                    }
                }
            }
        }
    } else {
        if (onlyThis.value === "" || onlyThis.value.length === 0) {
            SetControlAsNotValid(onlyThis.id);
            isFormValid = false;
        } else {
            SetControlAsValid(onlyThis.id);
        }
    }
}

/**
 * Change the status for control to not valid,
 * that's will applay red borders and color to tell
 * the user that the input is not valid.
 * @param {HtmlControl} controlId Control to change it's status.
 * @param {Boolean} makeLabelError wither to change also the lable of the this control or not.
 */
function SetControlAsNotValid(controlId, makeLabelError = true) {
    $("#" + controlId).attr(
        "style",
        "background-color: #FA8072; border-color: #FF0000; border-width:medium;"
    );

    if (controlId === "txtDescription") {
        $("#" + controlId).attr(
            "style",
            "background-color: #FA8072; border-color: #FF0000; border-width:medium; height:90px;"
        );
    }
    if (makeLabelError === true) {
        $("#" + controlId + "Label").attr("style", "color: red");
    }
}

/**
 * Change the status for control to valid,
 * which the default status for a control.
 * @param {HtmlControl} controlId Control to change it's status.
 */
function SetControlAsValid(controlId) {
    $("#" + controlId).attr(
        "style",
        "background-color: white; border-color: #white;  border-width:thin;"
    );

    if (controlId === "txtDescription") {
        $("#" + controlId).attr(
            "style",
            "background-color: white; border-color: #white;  border-width:thin; height:90px;"
        );
    }

    $("#" + controlId + "Label").attr("style", "color: #747474");
}

/**
 * Check the size of a file wither it's less or equal
 * the limited size of a file limit size, see appsettings.json:->
 *                                            Settings :-> FileLimitationsSettings: -> Size.
 * @param {bytes} file a file content as array of bytes.
 */
async function CheckFileSize(file) {
    const FileSize = file.files[0].size / 1024 / 1024;
    if (FileSize > 2) {
        $("#" + file.id + "LabelSizeValidation").attr(
            "style",
            "display: block; color: red; border-width:medium;"
        );
        SetControlAsNotValid(file.id, false);
    } else {
        $("#" + file.id + "LabelSizeValidation").attr(
            "style",
            "display: none; color: red; border-width:thin;"
        );
        SetControlAsValid(file.id);
    }
}

/**
 * Check the keyboard event wither it's number or not.
 * @param {key} event keyboard event.
 */
function isNumber(event) {
    event = event ? event : window.event;
    const charCode = event.which ? event.which : event.keyCode;
    return !(charCode > 31 && (charCode < 48 || charCode > 57));
}


/**
 * Check if string is following email address or not.
 * @param {string} email value to validated.
 */
function IsEmailValid(email) {
    const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    if (re.test(String(email.value).toLowerCase()) === false) {
        SetControlAsNotValid(email.id);
        $("#txtEmailLabelSizeValidation").attr(
            "style",
            "color: red; display: block;"
        );
    } else {
        SetControlAsValid(email.id);
        $("#txtEmailLabelSizeValidation").attr(
            "style",
            "color: red; display: none;"
        );
    }
}

/**
 * Hide all uploading file progress bar.
 */
function HideAllProgressUploadFiles() {
    const x = document.getElementsByTagName("INPUT");
    for (let cnt = 0; cnt < x.length; cnt++) {
        if (x[cnt].type === "file") {
            $("#" + x[cnt].id + "ProgressDiv").attr("style", "display: none;");
            $("#" + x[cnt].id + "Progress").attr(
                "style",
                "background-color: #0da67d !important; width: 0%"
            );
        }
    }
}

/**
 * Clear all values of all control.
 */
function ClearForm() {
    var x = document.getElementsByTagName("INPUT");
    var y = [];
    var cnt2 = 0;
    for (var cnt = 0; cnt < x.length; cnt++) {
        if (x[cnt].type == "text" || x[cnt].type == "file") {
            x[cnt].value = "";
            SetControlAsValid(x[cnt].id);
        }
    }

    $("#formContainer *").removeAttr("disabled");
    $("#DivSubmitting").attr("style", "display: none");
    $("#ButtonSubmit").show();
    $("#DivSubmitting").hide();
    HideAllProgressUploadFiles();
}

/**
 * Sumbit a form to the backend.
 */
async function Submit() {
    Validation(null, true);
    if (isFormValid === true) {
        grecaptcha
            .execute(googleRecapchaSiteKey, {action: "submit"})
            .then(async function (token) {
                $("#formContainer *").attr("disabled", "disabled").off("click");
                $("#DivSubmitting").show();
                $("#ButtonSubmit").hide();
                googleToken = token;
                const response = await CreateVendor();
                console.log(response);
                if (response.isError === false) {
                    console.log(response.vendor.requestNumber);
                    $("#LabelRequestNumber").text(response.vendor.requestNumber);
                    $("#RegisterDone").modal("show");
                    $("#RegisterNewVendor").modal("hide");
                    ClearForm();
                }
            });
    }
}

/**
 * Send a request to backend to create vendor.
 * @returns {Promise<jQuery|HTMLElement|{getAllResponseHeaders: (function(): *), abort: (function(*=): *), setRequestHeader: (function(*=, *): *), readyState: number, getResponseHeader: (function(*): *), overrideMimeType: (function(*): *), statusCode: (function(*=): $)}|*|{getAllResponseHeaders: (function(): *), abort: (function(*=): *), setRequestHeader: (function(*=, *): *), readyState: number, getResponseHeader: (function(*): *), overrideMimeType: (function(*): *), statusCode: (function(*=): $)}>}
 * @constructor
 */
async function CreateVendor() {
    try {
        var files = await SetupFiles();
        return await $.ajax({
            type: "POST",
            data: JSON.stringify({
                Name: $("#txtOrganization").val(),
                CRNumber: $("#txtCrNumber").val(),
                Contacts: [{
                    Value: $("#txtEmail").val(),
                    Type: "Email"
                }, {
                    Value: $("#txtPhone").val(),
                    Type: "Phone"
                }],
                Description: $('#description :selected').text(),
                GoogleToken: googleToken,
                Files: files
            }),
            url: sitePrefix + "CreateVendor",
            contentType: "application/json",
        });
    } catch (e) {
        return e.responseJSON;
    }
}

/**
 * Upload files to vendor folder.
 * @param {string} vendor vendor how have has those files.
 */
async function SetupFiles() {
    const x = document.getElementsByTagName("INPUT");
    var files = [];
    for (let cnt = 0; cnt < x.length; cnt++) {
        if (x[cnt].type === "file") {
            if (x[cnt].files[0]) {
                files.push(await CreateFileObject(x[cnt].id, x[cnt]));
            }
        }
    }

    return files;
}

/**
 * Update the progress bar file
 * @param {*} fileName file to upload.
 * @param {*} file as 64 base string to upload.
 * @param {*} vendor to upload file.
 */
async function CreateFileObject(fileName, file, vendor) {
    $("#" + fileName + "ProgressDiv").attr("style", "display: block;");
    const fileDetails = {
        Name: fileName + ".pdf",
        Content: await processFile(file.files[0])
    };

    return fileDetails;
}

/**
 * Read the upload file
 * @param file
 * @returns {Promise<unknown>}
 */
function readFileAsync(file) {
    return new Promise((resolve, reject) => {
        let reader = new FileReader();

        reader.onload = () => {
            resolve(reader.result);
        };

        reader.onerror = reject;

        reader.readAsDataURL(file);
    });
}

/**
 * Handel the upload file.
 * @param file
 * @returns {Promise<unknown>}
 */
async function processFile(file) {
    try {
        return await readFileAsync(file);
    } catch (err) {
        console.log(err);
    }
}
3e      _?_?BXg_>   )    :https://10.110.119.58/VRS/scripts/app.js strongly-framed 1 security-info FnhllAKWRHGAlo+ESXykKAAAAAAAAAAAwAAAAAAAAEaphjojH6pBabDSgSnsfLHeBAQAAgAAAAAAAAAAAAAAAAAAAAAB4vFIJp5wRkeyPxAQ9RJGKPqbqVvKO0mKuIl8ec8o/uhmCjImkVxP+7sgiYWmMt8FvcOXmlQiTNWFiWlrbpbqgwAAAAAAAAOvMIIDqzCCApOgAwIBAgIEDaFk1DANBgkqhkiG9w0BAQsFADCBijEUMBIGA1UEBhMLUG9ydFN3aWdnZXIxFDASBgNVBAgTC1BvcnRTd2lnZ2VyMRQwEgYDVQQHEwtQb3J0U3dpZ2dlcjEUMBIGA1UEChMLUG9ydFN3aWdnZXIxFzAVBgNVBAsTDlBvcnRTd2lnZ2VyIENBMRcwFQYDVQQDEw5Qb3J0U3dpZ2dlciBDQTAeFw0yMDA4MDYyMDQ5MzNaFw0yMTA4MDYyMDQ5MzNaMGcxFDASBgNVBAYTC1BvcnRTd2lnZ2VyMRQwEgYDVQQKDAtQb3J0U3dpZ2dlcjEXMBUGA1UECwwOUG9ydFN3aWdnZXIgQ0ExIDAeBgNVBAMMF1JXREhPUlNFMDFBLmFkYWEuZ292LnNhMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAjO01ND8kjSZ5cTRKiRlf97E9r1LRbq0Kg/mGXin8BgMFq4XjVBfZKYuAnRWBVf9Y0ykG6vHeb6QuAsy+J3RBueGtk4yR0oODQBYT72lZR5UrfJNH30wMQho5wgikp6+Jp5TTzHiwOxoqm4Q8aKYlLZx6EER+bR3cmOIujw2cDNYec11t3EmEl20MfZ4uSYy/RRsmklCU/Gxu8cGucsnCLj7OD4xDsb0vPVRhcbEGMCUboXjtaxgTx0SODJroLMSYN1touWRA8ioSFX7//o8g6zd5cn/Jl5+zCavzppgO0y12xb1BK3FaUEoNG1EUqiqk/7QoNe0CWEtPT8EIqY5nRQIDAQABozswOTAiBgNVHREEGzAZghdSV0RIT1JTRTAxQS5hZGFhLmdvdi5zYTATBgNVHSUEDDAKBggrBgEFBQcDATANBgkqhkiG9w0BAQsFAAOCAQEAe+HYQaVk4GggPLz1JQcVjCh/hALxNqbSUbw10XE1ngJytv+dHm36ohSMWwGft8imHJceBPKZF3Gx1vfj3wHWFNT1uZfycRcSt4y9FvGNcGor+D5zobE469LrEg9KCTuJGkZLY18AtM4LxvCzLHRVOrlu2SmRmPV0f3johJS4B3DxzABzdKEI/PskbWonjsN3IRxaXMCjzWs7mzAaVLQ08FWspv+JaF4h07ZYQBl0JrwDlGzH3dAQlW7nLrzqaYNHRpgCE7iUscpuLgF/b9uVYFEpkCF/XUig82P8q2cwsUmqrU2SOP9AIIDIlsCAm8PcnKcQJIP0wp6JptQsc1ww1sAwAQMBAAEAAQEBAAAA request-method GET request-Accept-Encoding gzip, deflate, br response-head HTTP/1.1 200 OK
Content-Type: application/javascript
Etag: "1d67538f69b6544"
Vary: Accept-Encoding
Content-Length: 11204
Last-Modified: Tue, 18 Aug 2020 08:24:17 GMT
Accept-Ranges: bytes
Server: Microsoft-IIS/10.0
Strict-Transport-Security: max-age=2592000
X-Powered-By: ASP.NET
Date: Thu, 20 Aug 2020 10:53:51 GMT
 original-response-headers Content-Type: application/javascript
Last-Modified: Tue, 18 Aug 2020 08:24:17 GMT
Accept-Ranges: bytes
Etag: "1d67538f69b6544"
Vary: Accept-Encoding
Server: Microsoft-IIS/10.0
Strict-Transport-Security: max-age=2592000
X-Powered-By: ASP.NET
Date: Thu, 20 Aug 2020 10:50:19 GMT
Connection: close
Content-Length: 11204
 uncompressed-len 0 net-response-time-onstart 464 net-response-time-onstop 464 charset windows-1252   +